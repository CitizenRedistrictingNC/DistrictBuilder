{% extends "viewplan.html" %}

{% comment %}

   Copyright 2010 Micah Altman, Michael McDonald

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   This file is part of The Public Mapping Project
   http://sourceforge.net/projects/publicmapping/

   Purpose:
       This template is a full featured editing interface.

       This template extends the map viewing interface, and adds editing
       tools and features to the toolbars.

   Author:
       Andrew Jennings, David Zwarg

{% endcomment %}

      {% block toolset_history %}
          <button id="history_undo" class="{% if not plan %}disabled{% else %}{% ifequal plan.version 0 %}disabled{% endifequal %}{% endif %}">Undo</button>
          <button id="history_redo" class="disabled">Redo</button>
          <input id="history_cursor" type="hidden"/>
      {% endblock %}
      
      {% block toolset_tabs %}
          <ul class="mapping_tabs">
            <li><a href="#toolset_draw">Map Editing</a></li>
            <li><a href="#toolset_district">{{ body_member|capfirst }} Tools</a></li>
          </ul>  
      {% endblock %}
      
      
          
      {% block toolset_draw %}
      <div class="toolset" id="toolset_draw">
        <div class="toolset_group">
          <div>
          <button class="navigate_map_tool active btntoggle toggle">Pan</button><br/>
          <button class="identify_map_tool btntoggle titletip" title="Click on a geounit to see its demographic info." >Info</button>
          </div>
         </div>
       
        <div class="toolset_group toolset_group_lg">
          <div>
            <button id="single_drawing_tool" title="Single {{ body_member }} select; +Shift to select multiple {{ body_members}}" class="btntoggle titletip" >Single<br/>Select</button>
            <button id="rectangle_drawing_tool" title="Select by rectangle" class="btntoggle titletip" >Rectangle<br/>Select</button>
            <button id="polygon_drawing_tool" title="Select by drawing a polygon" class="btntoggle titletip">Polygon<br/>Select</button>
          </div>
        </div>  
        <div class="toolset_group toolset_group_lg">
          <div>
            <button id="anchor_tool" class="titletip" title="Enable anchor mode, then select a {{ body_member }} name to repeatedly assign areas to a {{ body_member }}">Anchor<br/>{{ body_member|capfirst }}</button>
            <div class="button_group" id="control_assign_district">
              <label>Assign to {{ body_member|capfirst }}</label><br/>
              <select id="assign_district" class="titletip" title="Assign {{ body_members }} currently selected on map by choosing a {{ body_member }} name from drop down list">
              <option value="-1">-- Select One --</option>
              {% for d in districts %}
                  <option value="{{ d.district_id }}">{{ d.name }}</option>
              {% endfor %}
              {% ifnotequal max_dists districts|length %}
                  <option value="new">New {{ body_member|capfirst }}</option>
              {% endifnotequal %}
            </select>
            </div>
            <button id="dragdrop_tool" class="titletip" title="Select areas on the map then drag them to into a {{ body_member }} for reassignment">Click and<br/>Drag</button>
          </div>
        </div>
        <div class="toolset_group toolset_group_lg last">  
        {% if not plan.is_community %}
          <div id="fix_unassigned">
            <button id="fix_unassigned_button">Fix<br/>Unassigned</button>
          </div>
          {% endif %}
          
            {% comment %}
            
            This hidden div is used to style the locked districts.
            This is needed, because the locked legend item does not
            exist before the first district layer is drawn.
            
            {% endcomment %}
            <div class="locked" style="display:none"></div>
        </div>
        <div class="clear"></div>
      </div>
      {% endblock toolset_draw %}

      {% block toolset_district %}
      <div class="toolset" id="toolset_district">
        <div class="toolset_group">
          <button class="navigate_map_tool active btntoggle toggle">Pan</button><br/>
          <button class=" identify_map_tool btntoggle titletip" title="Click on a geounit to see its demographic info.">Info</button>
        </div>
        <div class="toolset_group toolset_group_lg">
            <button id="lock_district_map_tool" title="Click on a {{ body_member }} to lock or unlock it." class="btntoggle titletip">Lock<br/>{{ body_member|capfirst }}</button> 
            <button id="district_id_map_tool" title="Click on a {{ body_member }} to see its ID." class="btntoggle titletip">{{ body_member|capfirst }}<br/>Info</button> 
            <button id="district_select_tool" title="Unassign all the units in a {{ body_member }}" class="btntoggle titletip">Unassign<br/>{{ body_member|capfirst }}</button>
            <button id="copy_paste_tool" title="Copy a {{ body_member }} from another plan" class="titletip">Copy and</br>Paste</button>
        </div>

        <div class="toolset_group toolset_group_lg">
          <button id="show_splits_button">Show<br/>Splits</button>
          <button id="generate_splits_report_button">Generate<br/>Splits Report</button>
         </div>
        
        <div class="toolset_group toolset_group_lg last">       
          {% if plan.legislative_body.multi_members_allowed %}
          <button id="multi_member_toggle">Select Multi-<br/>Member Districts</button>
          {% endif %}
        </div>
        <div class="clear"></div>
      </div>
          
                    

      {% endblock %}
      
        {% block share_panel %}
            <div class="explanation">
                <h3>Explanation of Shared Documents</h3>
                <p>You can share your plan with other users here.  Your plan will be available for other users so that they can view reports about your plan or create a plan of their own using yours as a base.</p>
                <p>Give your plan a unique name in order to share it. A copy of your current plan will be added to the "Shared Plans" section of the plan chooser.</p>
            </div>
            <div id="nameandshare">
                <div>
                    <h3>Name your shared plan</h3>
                    <input id="txtPlanName" />
                    <button id="btnSaveAndShare">Save and Share</button>
                </div>

            </div>
            <div id="successfulShare" title="Congratulations!" >
                <p>You have successfully shared your plan. You can share your plan with others by giving them this link:</p>
                <p id="sharedPermalink"><p>
                <button id="continueEditing">Continue Editing Current Plan</button>
                <a href="/districtmapping/plan/0/view/"><button id="selectNew">Select New Plan to Edit</button></a>
            </div>
        {% endblock %}

    {% block verify_submit %}
        {% if has_leaderboard and not plan.is_community %}
        <div id="verifyandpost">
            <div class="explanation">
               <h3>Verify and Post Plan to Leaderboards</h3>
                <p>To be considered for submission to the leaderboard, a plan must first be submitted for verification that it meets the competition criteria for a legal district plan. Keep in mind that as soon as you edit a verified plan, it will automatically become "unverified" and you will need to re-verify it in order for it to again be considered for the leaderboards.</p>
                <p>By verifying your plan, you are <em><strong>not</strong></em> sharing your plan with other users. If your plan qualifies for the top ten plans list for any of the four score types and you have not yet shared your plan with the public, your <strong>plan name</strong> and <strong>user name</strong> will simply be listed in the leaderboard table. If you HAVE shared your plan with the public, your plan name will be hyperlinked with the plan's unique URL.</p>
                <p>
                How to verify and submit your plan:
                <ol>
                  <li>Click the "Verify and Submit" button.</li>
                  <li>Wait for the plan to be verified. </li>
                  <li>If it is verified, you will be taken to the Leaderboard page. </li>
                  <li>Check the leaderboards to see if your plan ranks in the top ten for any of the four available score types. </li>
                  <li>Click on the "My Ranked Plans" to check your plans' ranking as compared to all verified plans.</li>
                </ol>
                </p>
            </div>
            <button id="btnVerifyAndSubmit">Verify and Submit Plan</button>            
        </div>
        {% endif %}
    {% endblock %}

    {% block shared_districts %}
    <div id="shared_districts_dialog">
        <!-- <div id="header"><h3></h3></div> -->
        <div id="shared_districts_content">
            <div id="shared_districts_instructions">
            {% if plan.is_community %}
            <p>Choose communities to paste into your map. A map can contain any number of communities. If you would like to remove communities from your map, use the community unassign tool.</p>
            {% else %}
            <p>Choose districts to paste into your plan.  A plan has a maximum number of districts allowed by law.  If you would like to paste districts into a plan, you must have fewer districts in your plan than the maximum allowed.  If you would like to remove districts from your plan, use the district unassign tool.</p>
            {% endif %}
            </div>
            <div id="shared_plans_column">
                <h2>1. Choose Plan</h2>
                <table id="shared_plans_table"></table>
                <div id="shared_plans_pager"></div>
            </div>
            <div id="shared_districts_column">
                <input type="hidden" id="available_districts">
                <h2>2. Select {{ body_member|capfirst }} to copy</h2>
                <table id="shared_districts_table"></table>
                <div id="shared_districts_pager"></div>
            </div>
            <div id="shared_district_maps">
               
               <div id="shared_district_map_div"></div>
               <p><strong>Click on a {{ body_member }}'s name to see a map</strong></p>
            </div>
        </div>
        <div id="footer">
            <div id="message_box"></div>
            <div id="step_3">
                <h2>3. Paste selected {{ body_member }} into working plan</h2>
                <button id="paste_button">Paste</button>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="/static-media/js/shareddistricts.js"></script>
    <script type="text/javascript">
        $(function() {
            var shared = shareddistricts({
                container: $('#shared_districts_dialog'),
                target: $('#copy_paste_tool'),
                planTable: $('#shared_plans_table'),
                planPager: $('#shared_plans_pager'),
                planUrl: '/districtmapping/getplans/',
                districtTable: $('#shared_districts_table'),
                districtPager: $('#shared_districts_pager'),
                districtUrl: '/districtmapping/plan/PLAN_ID/shareddistricts/',
                submitButton: $('#paste_button'),
                handlerUrl: '/districtmapping/plan/{{ plan.id }}/pastedistricts/',
                availableDistricts: {{ available_districts }}
            }).init();
        });
    </script>
    {% endblock %}

    {% block stats_editor %}
    <div id="stats_editor_container" class="stats_editor" title="Edit Statistics Sets">
        <div id="stats_editor_instructions">
            You can select up to three statistics at once to display in the sidebar. Each set of three
            statistics will be saved in the dropdown for you to select or edit later. You may have up
            to three sets of statistics saved.
        </div>
        1. Select up to 3 statistics
        <button id="clear_statistics">Clear Choices</button>
        <div id="available_statistics"> </div>
        
        <div id="name_statistics_set">
            2. Name Statistics Set
            <input type="text" id="statistics_set_name" maxlength="50" />
            <button id="save_statistics_set">Save Set</button>
        </div>
        <div id="existing_statistics_set">
            ... Or select a saved statistics set
        </div>
        <div id="saved_statistics_sets"> </div>
    </div>
    {% endblock %}

    
    {% block multi_member %}
    {% if plan.legislative_body.multi_members_allowed %}
    <div id="multi_member_dialog">
        <div id="multi_member_content">
            <div id="multi_member_grid_container">
                <table id="multi_member_grid"></table>
            </div>
            <div id="multi_member_info">
                <div id="multi_member_instructions">
                    <p>
                        Click on a row to edit the number of members for the selected
                        district. Press ENTER to complete editing a district.
                    </p>
                    <br />
                    <p>
                        When all desired edits are made, press the Save button to
                        save all changes to the database.
                    </p>
                </div>
                <div id="multi_member_targets">
                    <p>Target # of representatives: <span id="multi_target_reps"></span></p>
                    <p>Target # of multi-member districts: <span id="multi_target_dists"></span></p>
                    <p>Target # of members per multi-member district: <span id="multi_target_per"></span></p>
                </div>
                <div id="multi_member_values">
                    <p>Your plan currently has <span id="multi_num_reps" class="multi_val"></span> representatives.</p>
                    <p>Your plan currently has <span id="multi_num_dists" class="multi_val"></span> multi-member districts.</p>
                </div>
                <div id="multi_member_footer">
                    <button id="multi_member_save_button">Save</button>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="/static-media/js/multimember.js"></script>
    <script type="text/javascript">
        $(function() {
            multimember({
                container: $('#multi_member_dialog'),
                editContainer: $('#multi_member_edit_container'),
                memberGrid: $('#multi_member_grid'),
                numMembersContainer: $('#multi_num_reps'),
                numMultiDistsContainer: $('#multi_num_dists'),
                targetMembersContainer: $('#multi_target_reps'),
                targetMultiDistsContainer: $('#multi_target_dists'),
                targetMembersPerDistContainer: $('#multi_target_per'),
                minMultiDistricts: {{ plan.legislative_body.min_multi_districts }},
                maxMultiDistricts: {{ plan.legislative_body.max_multi_districts }},
                minMultiDistrictMembers: {{ plan.legislative_body.min_multi_district_members }},
                maxMultiDistrictMembers: {{ plan.legislative_body.max_multi_district_members }},
                minPlanMembers: {{ plan.legislative_body.min_plan_members }},
                maxPlanMembers: {{ plan.legislative_body.max_plan_members }},
                target: $('#multi_member_toggle'),
                assignButton: $('#multi_member_save_button'),
                workingDialog: $('#working'),
                handlerUrl: '/districtmapping/plan/{{ plan.id }}/districtmembers/',
                getDistrictsFn: function() {
                    return $(olmap.getLayersByName("Current Plan")[0].features).map(function(i, f) {
                        return f.data;
                    });
                },
                getVersionFn: function() {
                    return $('#history_cursor').val();
                }
            }).init();
        });
    </script>
    {% endif %}
    {% endblock %}


    {% block splits_report %}
    <div id="splits_report_dialog">
        <div id="splits_report_content">
            <div id="splits_report_select_panel">
                <h2>Generate Splits Report for Current Plan</h2>
                <div id="splits_report_reminder_text">
                    Select up to 3 reference layers for comparison.
                </div>
                <div id="splits_report_available_layers">
                    {% for snap in snaplayers %}
                    {% if not forloop.last %}                    
                    <div class="layer_choice_wrapper">
                        <input id="geolevel.{{ snap.geolevel }}" class="layer_choice" type="checkbox" value="geolevel.{{ snap.geolevel }}" />
                        <label for="geolevel.{{ snap.geolevel }}">{{ snap.name }}</label>
                    </div>                  
                    {% endif %}
                    {% endfor %}
                </div>

                <h2>Advanced option</h2>
                <div class="inverse_choice_wrapper">
                    <input id="inverse_choice" type="checkbox" />
                    <label id="inverse_choice_label" for="inverse_choice">
                        Reverse splits detection:
                        
                    </label>
                    <div id="inverse_choice_label_more">
                        Where selected reference layers split current plan boundaries
                    </div>
                </div>                  

                <div id="splits_report_ok_div">
                    <button id="splits_report_ok_button">Generate Report</button>
                </div>
            </div>
            <div id="splits_report_results_panel">
                <h2>Splits Report</h2>
                <div id="splits_report_results_container">
                  <p>No report generated.</p>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="/static-media/js/splitsreport.js"></script>
    <script type="text/javascript">
        $(function() {
            splitsreport = splitsreport({
                container: $('#splits_report_dialog'),
                target: $('#generate_splits_report_button'),
                okButton: $('#splits_report_ok_button'),
                inverseCheckbox: $('#inverse_choice'),
                availableLayers: $('#splits_report_available_layers'),
                referenceLayerSelect: $('#reference_layer_select'),
                splitsReportUrl: '/districtmapping/plan/{{ plan.id }}/splitsreport/',
                resultsContainer: $('#splits_report_results_container'),
                map: $('#map'),
                getVersionFn: function() {
                    return $('#history_cursor').val();
                }
            }).init();
        });
    </script>
        
    {% endblock %}

    {% block district_info %}
    {% if plan.is_community %}
    <div id="districtComment" title="Community Info">
        <input type="hidden" value="0" id="id_district_pk" name="district_pk"/>
        <input type="hidden" value="" id="id_district_id" name="district_id"/>
        
        <div class="dialog_step">
          <h3>1. Edit Community Label:</h3>
          <div id="district_label" class="district_input">
              <input type="text" class="field" value="" id="id_label" name="label" maxlength="200"/>
          </div>
        </div>
        
        <div class="dialog_step">
          <h3>2. Edit Community Type:</h3>
          <div id="district_type" class="district_input">
              <select name="type" id="id_type" multiple="multiple" size="4">
                  {% for tag in tags %}<option value="{{ tag }}">{{ tag }}</option>
                  {% endfor %}
              </select>
          </div>
        </div>
        
        <div class="dialog_step">
          <h3>3. Comments:</h3>
              <p>
                  <textarea id="id_comment" name="comment" cols="40" rows="10"></textarea>
              </p>
        </div>
        
        </div>
    </div>
    <div id="districtCommentErr" title="Oops!">
        <div>Sorry, your information could not be saved. Please try again later.</div>
    </div>
    {% endif %}
    {% endblock %}
