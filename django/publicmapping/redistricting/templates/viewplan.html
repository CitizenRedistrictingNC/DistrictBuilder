{% comment %}

   Copyright 2010 Micah Altman, Michael McDonald

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   This file is part of The Public Mapping Project
   http://sourceforge.net/projects/publicmapping/

   Purpose:
       This template is a basic mapping interface.

       This template provides basic mapping functionality for viewing and
       navigating districts and plans. The editplan template extends this
       functionality by providing editing tools.

   Author: 
       Andrew Jennings, David Zwarg

{% endcomment %}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="author" content="David Zwarg, Andrew Jennings" />
    <meta name="copyright" content="&copy; 2010 Micah Altman, Michael McDonald"/>
    <title>Open Source District Mapping Tool</title>
    <link rel="stylesheet" type="text/css" href="/site-media/css/reset.css"/>
    <link rel="stylesheet" type="text/css" href="/site-media/jquery/themes/custom-theme/jquery-ui-1.8.2.custom.css"/>
    <link rel="stylesheet" type="text/css" href="/site-media/css/publicmapping.css"/>
    <script type="text/javascript" src="/site-media/openlayers/OpenLayers.js"></script><!-- production -->
    <!-- <script type="text/javascript" src="/site-media/OpenLayers-2.9.1/lib/OpenLayers.js"></script> debug -->

    {% comment %}

    Initialize the variables required for rendering the map on this page.
    These variables are pulled from the django settings module, and 
    dynamically computed from the current plan of interest.
    
    {% endcomment %}
    <script type="text/javascript">
        // The name of the map server that serves up map tiles.
        var MAP_SERVER = '{{ mapserver }}';
        // The namespace configured for WFS requests
        var NAMESPACE = '{{ namespace }}';
        // The namespace HREF configured for WFS requests
        var NS_HREF = '{{ ns_href }}';
        // The maximum number of features that can be manipulated at once.
        var FEATURE_LIMIT = {{ feature_limit }};

        // The ID of the plan that this page is viewing
        var PLAN_ID = {% if plan %}{{ plan.id }}{% else %}0{% endif %};
        // The most current version of the plan. When viewing a plan,
        // the most current plan version is initially displayed.
        var PLAN_VERSION = {% if plan %}{{ plan.version }}{% else %}0{% endif %};
        // The id of the special 'unassigned' district.
        var UNASSIGNED_DISTRICT_ID = {% if unassigned_id %}{{ unassigned_id }}{% else %}0{% endif %};
        // An array of configuration settings for the layers that are
        // used to select geography.
        var SNAP_LAYERS = [ {% for snap in snaplayers %} { geolevel: {{ snap.geolevel }}, level: '{{ snap.layer }}',layer: 'simple_{{ snap.layer }}', name: '{{ snap.name }}' }{% if not forloop.last %},{% endif %} {% endfor %} ];
        // An array of demographic settings for the choropleth variations 
        // of the snap layer
        var DEMOGRAPHICS = [{% for demo in demographics %} { id: {{ demo.id }}, text: '{{ demo.text }}', value: '{{ demo.value }}', isdefault: {{ demo.isdefault }}, isdisplayed: {{ demo.isdisplayed }} }{% if not forloop.last %},{% endif %} {% endfor %} ]; var MAP_LAYERS = []; for (var i = 0; i < SNAP_LAYERS.length; i++) { MAP_LAYERS.push( 'gmu:demo_' + SNAP_LAYERS[i].level );
            for (var j = 0; j < DEMOGRAPHICS.length; j++) {
                MAP_LAYERS.push( 'gmu:demo_' + SNAP_LAYERS[i].level + '_' + DEMOGRAPHICS[j].value );
            }
        }
        // The style rules for all subjects. Each subject has a different
        // set of ranges, and they are pulled from the django db.
        var RULES = { {% for rule in rules %}'{{ rule.subject_id }}': {lowest: {{ rule.lowest }}, lower:{{ rule.lower }}, upper:{{ rule.upper }}, highest: {{ rule.highest }} }{% if not forloop.last %},{% endif %}{% endfor %}};
        // The maximum number of districts that can exist in this plan.
        var MAX_DISTRICTS = {{ max_dists }};
        {% if upload %}
        var UPLOADED = true;
        var UPLOAD_STATUS = {% if upload_status %}true{% else %}false{% endif %};
        {% endif %}
    </script>
    {% comment %}

    Load external javascript libraries.

    {% endcomment %}
    <script type="text/javascript" src="/site-media/jquery/jquery-1.4.2.js"></script>
    <script type="text/javascript" src="/site-media/jquery/jquery-ui-1.8.2.custom.min.js"></script>
    <script type="text/javascript" src="/site-media/jquery/external/jquery.tools.tooltip.slide.min.js"></script>
    {% comment %}

    Load internal javascript logic.

    {% endcomment %}
    <script type="text/javascript" src="/site-media/js/ui.js"></script>
    <script type="text/javascript" src="/site-media/js/viewablesorter.js"></script>
    <script type="text/javascript" src="/site-media/js/mapping.js"></script>
    <script type="text/javascript" src="/site-media/js/chooseplan.js"></script>
    <script type="text/javascript" src="/site-media/js/districtindexfile.js"></script>
    <script type="text/javascript" src="/site-media/js/reports.js"></script>
    <script type="text/javascript" src="/site-media/js/register.js"></script>
    {% comment %}

    Load Google Analytics Script if the ga_account has been set

    {% endcomment %}
    {% if ga_account %}
        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', '{{ ga_account }}']);
          {% if ga_domain %}
          _gaq.push(['_setDomainName', '{{ ga_domain }}']);
          {% endif %}
          _gaq.push(['_trackPageview']);

          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
        </script>
    {% endif %}

  </head>
  <body onload="init();" id="app">
 
  <div id="app_header">
    <div id="logo"><img src="/site-media/images/title-app.png" /></div>
    <div id="site_nav">
        <ul>
            {% if not is_registered %}
            {% comment %}

            If the user is anonymous, display a login link.

            {% endcomment %}
            <li><a class="last" href="/">Login</a></li>
            {% else %}
            {% comment %}

            If the user is logged in, display a link to an account 
            management panel, and a logout link.

            {% endcomment %}
            <li><a href="#" onclick="$('#register').dialog('open');return false;">My Account</a></li>
            <li><a class="last" href="/accounts/logout/">Logout</a></li>
            {% endif %}
        </ul>
    </div>
    <div class="clear"></div>
  </div>

  <div id="steps">
      <ul id="steps_tabs">
        <li id="tab_step1"><a href="#step-1">Step 1: Draw</a></li>
        <li id="tab_step2"><a href="#step-2">Step 2: Evaluate</a></li>
        <li id="tab_step3"><a href="#step-3">Step 3: Share</a></li>
      </ul>

   <div id="step-1" class="main_content">
 
      <div id="mapandmenu">
         <div class="toolbar ui-widget-header">
          <div id="toolsets">
            <div class="toolset" id="toolset_edit">
              <div class="toolset_group">
                <img src="/site-media/images/icon-help.png" class="help divtip">
                <div class="tooltip">The selected layer will be editable.  You will use the features in the selected layer to edit districts</div>
                <label>Snap Map to:</label>
                {% comment %}

                Dynamically populate the 'Snap Map to:' dropdown, based
                on the layers that are configured in the application.

                {% endcomment %}
                <select id="snapto">
                  <script type="text/javascript">
                    for (var i = 0; i < SNAP_LAYERS.length; i++) {
                        var snap = SNAP_LAYERS[i];
                        document.write('<option value="' + snap.layer + ';' + snap.level + '">' + snap.name + '</option>');
                    }
                  </script>
                </select>
              </div>
              <div class="toolset_group">
                <img src="/site-media/images/icon-help.png" class="help divtip">
                <div class="tooltip">The selected demographic attribute of current layer will be displayed on the map as a grayscale 'choropleth' overlay</div>                
                <label>Show Layer by:</label>
                {% comment %}

                Dynamically populate the "Show Layer by:" dropdown, based
                on the demographics that are configured in the application.

                {% endcomment %}
                <select id="showby">
                  <script type="text/javascript">
                    for (var i = 0; i < DEMOGRAPHICS.length; i++) {
                        var demo = DEMOGRAPHICS[i];
                        if ( i == 0 ) {
                            document.write('<option value="none">None</option>');
                        }
                        document.write('<option value="' + demo.value + '"');
                        if (demo.isdefault) {
                            document.write(' selected="true"');
                        }
                        document.write('>' + demo.text + '</option>');
                    }
                  </script>
                </select>
              </div>

              <div class="toolset_group">
                <img src="/site-media/images/icon-help.png" class="help divtip">
                <div class="tooltip">The appearance of the districts on the map</div>                
                <label>Show Districts by:</label>
                {% comment %}

                Dynamically populate the "Show Districts by:" dropdown,
                based on the demographics that are configured in the 
                application.

                {% endcomment %}
                <select id="districtby">
                  <script type="text/javascript">
                    for (var i = 0; i < DEMOGRAPHICS.length; i++) {
                        var demo = DEMOGRAPHICS[i];
                        if ( i == 0 ) {
                            document.write('<option value="' + demo.id + '.None">None</option>');
                            document.write('<option value="' + demo.id + '.Compactness">Compactness</option>');
                            document.write('<option value="' + demo.id + '.Contiguity">Contiguity</option>');
                        }
                        if ( demo.isdisplayed ) {
                            document.write('<option value="' + demo.id + '"');
                            if (demo.isdefault) {
                                document.write(' selected="true"');
                            }
                            document.write('>' + demo.text + '</option>');
                        }
                    }
                  </script>
                </select>
              </div>
           
        {% block mode_toggle %}        
        {% comment %}

        Define a block named 'mode_toggle': this section can be overridden
        to change the name of the button. It is entitled "Navigation" by
        default, for viewing. For an editing interface, this button could
        be changed to another, more informative label, such as "Edit Map".

        {% endcomment %}
        <button class="toolbar_toggle" id="start_drawing">Navigation</button>
        {% endblock %}
            </div>

            <div class="toolset" id="toolset_draw">
              <div class="toolset_group">
                <label>Map Tools</label>
                <div>
                  <button id="navigate_map_tool" class="active btntoggle toggle"></button>
                  <button id="identify_map_tool" title="Click on a geounit to see its demographic info." class="btntoggle titletip"></button>
                  <button id="district_id_map_tool" title="Click on a district to see its ID." class="btntoggle titletip"></button>
                </div>
              </div>
              {% block toolset_draw %}
              {% comment %}

              Define a block named 'toolset_draw': this section is a place-
              holder for drawing/editing tools. By default, the viewer has
              no editing capability, so these elements would have to be
              implemented in an editor template that extends this viewer.

              {% endcomment %}
              {% endblock %}

              <button class="toolbar_toggle" id="edit_map_settings">Select Map View</button>
            
            </div>
            </div>
            {% if plan %}
            {% comment %}

            If a plan exists, show the map sidebar menu.

            {% endcomment %}
            <div id="map_menu">
                <div id="map_menu_header">
                    <button class="menu_toggle ui-icon"></button>
                    <label>Current<br/> District</label>
                    <select>
                      <option value="demographics">Demographics</option>
                      <option value="geography">Basic Information</option>
                    </select>
                </div>
                <div class="map_menu_content geography">
                  <div class="plansummary">
                      <h3>Geography</h3>
                      <div><label>Population Equality:</label> <span class="value" >N/A</span></div>
                      <div><label>Contiguity:</label> <span class="value">N/A</span></div>
                      <div><label>Compactness:</label> <span class="value" >N/A</span></div>

                  </div>
                  <div class="plantable header">
                     <table>
                      <thead>
                          <tr>
                              <th class="celldist cell1"></th>
                              <th class="cellpop cell2"></th>
                              <th class="cellcontig cell3"></th>
                              <th class="cellcompact cell4"></th>
                          </tr>
                      </thead>
                   </table>
                  </div>
                  <div class="plantable body">
                    <div id="nogeography" class="error">Please select a plan to see district data</div>
                  </div>
                 <div class="menu_footer">
                    <button id="stats_legend">Stats Legend</button>
                    <div class="tooltip" id="stats_legend_panel">
                      <div class="legend_item">
                        <h5>Population</h5>
                        <ul>
                          <li><span class="swatch popstatus over"></span> Over target</li>
                          <li><span class="swatch popstatus under" id="swatch-under"></span> Under target</li>                       
                          <li><span class="swatch popstatus target" id="swatch-target"></span> Meets target</li>  
                        </ul>
                      </div>
                      <div class="legend_item last">
                        <h5>Contiguity</h5>
                        <ul>
                          <li><img src="/site-media/images/icon-check.png" class="yes-contiguous"> Contiguous</li>
                          <li><img src="/site-media/images/icon-warning.png" class="no-contiguous"> Non-contiguous</li>                 
 
                        </ul>
                      </div>                    
                    
                    </div>
                </div>
                </div>
                <div class="map_menu_content demographics">
                  <div class="plansummary">
                      <h3>Demographics</h3>
                      <div><label></label> <span class="value" ></span></div>
                      <div><label></label> <span class="value" ></span></div>
                      <div><label></label> <span class="value" ></span></div>
                  </div>
                  <div class="plantable header">
                     <table>
                      <thead>
                          <tr>
                              <th class="celldist cell1"></th>
                              <th class="cellpop cell2"></th>
                              <th class="cellcontig cell3"></th>
                              <th class="cellcompact cell4"></th>
                          </tr>
                      </thead>
                   </table>
                  </div>
                  <div class="plantable body">
                    <div id="nogeography" class="error">Please select a plan to see district data</div>
                  </div>
                </div>
            </div>
            {% endif %}
          </div>
          <div id="map">
            <div id="shadow_left"></div>
            <div id="shadow_top"></div>
          </div>
          <div id="map_legend">
              <button id="legend_toggle">Map Legend</button>
          </div>
          <div id="map_legend_content">
            <h1>Map Legend</h1>
            <table id="basemap_legend">
                <thead>
                    <tr>
                        <th colspan="2" id="legend_title">Total Population</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><div id="legend_swatch_1" class="swatch basemap_swatch">&nbsp;</div></td>
                        <td>0 - 100,000</td>
                    </tr>
                    <tr>
                        <td><div id="legend_swatch_2" class="swatch basemap_swatch">&nbsp;</div></td>
                        <td>100,000 - 500,000</td>
                    </tr>
                    <tr>
                        <td><div id="legend_swatch_3" class="swatch basemap_swatch">&nbsp;</div></td> <td>&gt; 500,000</td> </tr> </tbody>
            </table>
            <table id="district_legend">
                <thead>
                    <tr>
                        <th colspan="2">District</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><div id="district_swatch_farover" class="swatch farover district_swatch">&nbsp;</div></td>
                        <td>Far Over Target</td>
                    </tr>
                    <tr>
                        <td><div id="district_swatch_over" class="swatch over district_swatch">&nbsp;</div></td>
                        <td>Over Target</td>
                    </tr>
                    <tr>
                        <td><div id="district_swatch_within" class="swatch target district_swatch">&nbsp;</div></td>
                        <td>Within Target</td>
                    </tr>
                    <tr>
                        <td><div id="district_swatch_under" class="swatch under district_swatch">&nbsp;</div></td>
                        <td>Under Target</td>
                    </tr>
                    <tr>
                        <td><div id="district_swatch_farunder" class="swatch farunder district_swatch">&nbsp;</div></td>
                        <td>Far Under Target</td>
                    </tr>
                </tbody>
            </table>
          </div>
      </div>
    </div>
    <div id="step-2" class="main_content evaluate">
        <div id="reportdescription">
            <div id="description">
               <h3> Introduction to the reporting tool</h3>
                <p>Select the plan statistics you'd like included in a comprehensive report on your redistricting plan. After you've made your selections click "Create and Preview Report" to view the final report.</p>
            </div>
            <div id="options">
                <div id="options1">
                    <input type="hidden" id = "popVar" value="Total Population|POPTOT">
                    <span class="popVarExtra master" ><input id="popVarExtra_master" type="checkbox" /><label for="popVarExtra_master">Population</label></span>
                    <span class="popVarExtra child reportVar" ><input id="VAPTOT" type="checkbox"  value="VAPTOT" /><label for="VAPTOT">Voting Age Population</label></span>
                    <span class="popVarExtra child reportVar" ><input id="VAPNHWHT" type="checkbox"  value="VAPNHWHT" /><label for="VAPNHWHT">Voting Age Population - White</label></span>
                    <span class="popVarExtra child reportVar" ><input id="VAPBLK" type="checkbox"  value="VAPBLK" /><label for="VAPBLK">Voting Age Population - Black</label></span>
                    <span class="popVarExtra child reportVar" ><input id="VAPHISP" type="checkbox"  value="VAPHISP" /><label for="VAPHISP">Voting Age Population - Hispanic</label></span>
                    <span class="compactness master" ><input id="compactness_master" type="checkbox" /><label for="compactness_master">Compactness</label></span>
                    <span class="compactness child reportVar"><input id="repCompactness" type="checkbox" value="repCompactness" /><label for="repCompactness">Compactness - Length/Width</label></span>
                    <span class="compactness child reportVar"><input id="repCompactnessExtra" type="checkbox" value="repCompactnessExtra" /><label for="repCompactnessExtra">Compactness - Bounding Circle</label></span>
                    <span class="spatial master" ><input id="spatial_master" type="checkbox" /><label for="spatial_master">Spatial Analysis</label></span>
                    <span class="spatial child reportVar"><input id="repSpatialExtra" type="checkbox" value="repSpatialExtra" /><label for="repSpatialExtra">Contiguity</label></span>
                    <span class="spatial child reportVar"><input id="repSpatial" type="checkbox" value="repSpatial" /><label for="repSpatial">Unassigned Blocks</label></span>
                </div>
                <div id="options2">
                    <span class="racialComp master" ><input id="racialComp_master" type="checkbox" /><label for="racialComp_master">Racial Composition</label></span>
                    <span class="racialComp child reportVar"><input id="racialComp" type="checkbox" value="POPBLK"/><label for="POPBLK" >Majority Black</label></span>
                    <span class="racialComp child reportVar"><input id="racialComp" type="checkbox" value="POPHISP"/><label for="POPHISP" >Majority Hispanic</label></span>
                    <span class="partyControl master" ><input id="partyControl_master" type="checkbox" /><label for="partyControl_master">Party Control</label></span>
                    <span class="partyControl child reportVar"><input id="PRES_DEM" type="checkbox" value="PRES_DEM" /><label for="PRES_DEM">Democratic Votes</label></span>
                    <span class="partyControl child reportVar"><input id="PRES_REP" type="checkbox" value="PRES_REP" /><label for="PRES_REP">Republican Votes</label></span>
                    <span class="splitVar master" ><input id="splitVar_master" type="checkbox" /><label for="splitVar_master">Split Geographies</label></span>
                    <span class="splitVar child reportVar" ><input id="COUNTY" type="checkbox" value = "COUNTY" /><label for="COUNTY">County Splits</label></span>
                    <span class="splitVar child reportVar" ><input id="TRACT" type="checkbox" value="TRACT" /><label for="TRACT">Tract Splits</label></span>
                </div>
            </div>
            
        </div>
        <div id="reportPreviewContainer">
            <div id="reportPreview" class="report">
            </div>
        </div>
		<div id="reportButtons">
            <button id="btnPreviewReport">Create and Preview Report</button>
            <button id="btnSharePlans" onClick="$('#steps').tabs('select', '#step-3');return false;" >Go to Share Plan options</button>
                       
        </div>
		
    </div>
    <div id="step-3" class="main_content share">
        <div id="saveandshare">
            {% block share_panel %}
            {% comment %}

            Define a block entitled 'share_panel': this panel would show sharing
            options in an editor interface, but the default viewer does not have
            that capability.

            {% endcomment %}
            <div class="explanation">
                <h3>Shared Documents not available</h3>
                <p>If you were editing a plan, you could use this tab to share your plan with others<p>
            </div>
            {% endblock %}
            <hr />
            <div class="blockfile">
                <h3>District Index File export</h3>
                <p>You can export this plan to a district index file. The index file is a comma-separated-value file (csv) 
                with each line listing a geounit (such as a census block) and the district to which it belongs. This file
                can be imported to other instances of the publicmapping software or used in analysis of the plan using
                your favorite GIS software.</p>
                <button id="btnExportDistrictIndexFile">Export</button>
            </div>
        </div>
    </div>
</div>  
<div id="toolbar_plans">
     <div class="toolset_group first"> 
       <div class="planname">
          {% if plan.name %}
          {% comment %}

          If a plan exists and has a name, show the plan name at the 
          bottom left of the map.

          {% endcomment %}
          <label>Plan Name:</label> {{ plan.name }}
          {% else %}
          {% comment %}

          No plan exists, so indicate to the user that they must select
          a plan before anything else can happen.

          {% endcomment %}
          Please select a plan
          {% endif %}
      </div>
     </div>
     {% if plan and is_editable %}
     {% comment %}

     When a plan exists, and is editable, show a section that reflects the
     time that the plan was saved.

     {% endcomment %}
     <div class="toolset_group">
        {% if plan.edited %}
          {% comment %}

          Show the edited time of the plan.

          {% endcomment %}
          <div id="saveplaninfo" class="savedat">{{ plan.edited.isoformat }} </div>
        {% else %}
          {% comment %}

          Indicate that the plan has not yet been saved.

          {% endcomment %}
          <div id="saveplaninfo" class="savedat">Plan not saved</div>
        {% endif %}
      </div>
      {% endif %}
      <div class="toolset_group last"> 
          <div id="difplanbtn">Open New Plan</div>
      </div>
</div>
<div id="working" title="Please Wait">Please wait while new districts are computed...</div>
<div id="DialogContainer"></div>
<div class="olHandlerBoxSelectFeature" style="display:none;"></div>

{% comment %}

Include the markup for the account management panel.

{% endcomment %}
{% include "account.html" %}

<script type="text/javascript" defer="true">
    // run the initialization for these components when the page is ready
    $( function() {
        // initialize a working dialog
        $('#working').dialog({
            resizable:false,
            modal:false,
            position:[96,100],
            minHeight: 50,
            draggable:false,
            closeOnEscape:false,
            autoOpen:false,
            open: function(event,ui) {
                $('.ui-dialog-titlebar-close', $(this).parent()).hide();
            }
        });
        // initialize the plan chooser
        var choose = chooseplan({
            {% if not plan.name %}
            closable: false,
            {% endif %}
            anonymous: {% if is_registered %}false{% else %}true{% endif %},
            target: $('#difplanbtn'),
            container: $('#DialogContainer'),
            modal: true,
            resizable: false
        }).init();
    {% if plan.name %}
    {% comment %}

    If a plan exists, then load the geographic and demographic information
    about this plan, for display in the sidebar menu.

    {% endcomment %}
        $('.geography').load('/districtmapping/plan/{{plan.id}}/geography', { demo: 3 });
        $('.demographics').load('/districtmapping/plan/{{plan.id}}/demographics');      
    {% else %}
    {% comment %}

    If no plan, show the plan chooser, to prompt the user to create some
    plan to edit or view.

    {% endcomment %}
        choose.show();
    {% endif %}
        // initialize the reporting interface
        var report = reports({
            reportUrl: '/districtmapping/plan/{{plan.id}}/getreport/'
        }).init();
        var exportIndexFile = districtindexfile({
            target: $('#btnExportDistrictIndexFile')
        }).init();
    });
</script>
  </body>
</html>
